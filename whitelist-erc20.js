const Web3 = require("web3");
const provider = new Web3.providers.HttpProvider("http://localhost:22000");
// const provider = new Web3.providers.WebsocketProvider("ws://localhost:23000");
const web3 = new Web3(provider);

const utils = require("./utils.js");

const addressNode1 = "0xed9d02e382b34818e88b88a309c7fe71e65f419d";
const addressNode2 = "0xca843569e3427144cead5e4d5999a3d0ccf92b8e";
const addressNode3 = "0x0fbdc686b912d7722dc86510934589e0aaf3b55a";

let testCases = {
    "whitelist": {
        byteCode: "0x60806040523480156200001157600080fd5b5060405162001e8338038062001e83833981810160405281019062000037919062000193565b81600490805190602001906200004f92919062000071565b5080600590805190602001906200006892919062000071565b50505062000376565b8280546200007f906200029b565b90600052602060002090601f016020900481019282620000a35760008555620000ef565b82601f10620000be57805160ff1916838001178555620000ef565b82800160010185558215620000ef579182015b82811115620000ee578251825591602001919060010190620000d1565b5b509050620000fe919062000102565b5090565b5b808211156200011d57600081600090555060010162000103565b5090565b60006200013862000132846200022f565b62000206565b9050828152602081018484840111156200015157600080fd5b6200015e84828562000265565b509392505050565b600082601f8301126200017857600080fd5b81516200018a84826020860162000121565b91505092915050565b60008060408385031215620001a757600080fd5b600083015167ffffffffffffffff811115620001c257600080fd5b620001d08582860162000166565b925050602083015167ffffffffffffffff811115620001ee57600080fd5b620001fc8582860162000166565b9150509250929050565b60006200021262000225565b9050620002208282620002d1565b919050565b6000604051905090565b600067ffffffffffffffff8211156200024d576200024c62000336565b5b620002588262000365565b9050602081019050919050565b60005b838110156200028557808201518184015260208101905062000268565b8381111562000295576000848401525b50505050565b60006002820490506001821680620002b457607f821691505b60208210811415620002cb57620002ca62000307565b5b50919050565b620002dc8262000365565b810181811067ffffffffffffffff82111715620002fe57620002fd62000336565b5b80604052505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b611afd80620003866000396000f3fe608060405234801561001057600080fd5b50600436106100cf5760003560e01c806340c10f191161008c5780639b19251a116100665780639b19251a14610228578063a457c2d714610244578063a9059cbb14610274578063dd62ed3e146102a4576100cf565b806340c10f19146101be57806370a08231146101da57806395d89b411461020a576100cf565b806306fdde03146100d4578063095ea7b3146100f257806318160ddd1461012257806323b872dd14610140578063313ce56714610170578063395093511461018e575b600080fd5b6100dc6102d4565b6040516100e991906114d7565b60405180910390f35b61010c600480360381019061010791906112df565b610366565b60405161011991906114bc565b60405180910390f35b61012a61049e565b6040516101379190611619565b60405180910390f35b61015a60048036038101906101559190611290565b6104a8565b60405161016791906114bc565b60405180910390f35b610178610750565b6040516101859190611634565b60405180910390f35b6101a860048036038101906101a391906112df565b610759565b6040516101b591906114bc565b60405180910390f35b6101d860048036038101906101d391906112df565b610805565b005b6101f460048036038101906101ef919061122b565b610813565b6040516102019190611619565b60405180910390f35b61021261085c565b60405161021f91906114d7565b60405180910390f35b610242600480360381019061023d919061122b565b6108ee565b005b61025e600480360381019061025991906112df565b61099f565b60405161026b91906114bc565b60405180910390f35b61028e600480360381019061028991906112df565b610a93565b60405161029b91906114bc565b60405180910390f35b6102be60048036038101906102b99190611254565b610bcb565b6040516102cb9190611619565b60405180910390f35b6060600480546102e39061177d565b80601f016020809104026020016040519081016040528092919081815260200182805461030f9061177d565b801561035c5780601f106103315761010080835404028352916020019161035c565b820191906000526020600020905b81548152906001019060200180831161033f57829003601f168201915b5050505050905090565b6000336000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff166103f4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103eb906115b9565b60405180910390fd5b836000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16610480576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610477906115b9565b60405180910390fd5b61049261048b610c52565b8686610c5a565b60019250505092915050565b6000600354905090565b6000336000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16610536576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161052d906115b9565b60405180910390fd5b846000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff166105c2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016105b9906115b9565b60405180910390fd5b846000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff1661064e576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610645906115b9565b60405180910390fd5b610659878787610e25565b6000600260008973ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006106a4610c52565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905085811015610724576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161071b90611559565b60405180910390fd5b61074188610730610c52565b888461073c91906116c1565b610c5a565b60019450505050509392505050565b60006012905090565b60006107fb610766610c52565b848460026000610774610c52565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546107f6919061166b565b610c5a565b6001905092915050565b61080f82826110a7565b5050565b6000600160008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60606005805461086b9061177d565b80601f01602080910402602001604051908101604052809291908181526020018280546108979061177d565b80156108e45780601f106108b9576101008083540402835291602001916108e4565b820191906000526020600020905b8154815290600101906020018083116108c757829003601f168201915b5050505050905090565b6000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16156109445761099c565b60016000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548160ff0219169083151502179055505b50565b600080600260006109ae610c52565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905082811015610a6b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a62906115d9565b60405180910390fd5b610a88610a76610c52565b858584610a8391906116c1565b610c5a565b600191505092915050565b6000336000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16610b21576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610b18906115b9565b60405180910390fd5b836000808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900460ff16610bad576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ba4906115b9565b60405180910390fd5b610bbf610bb8610c52565b8686610e25565b60019250505092915050565b6000600260008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415610cca576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610cc190611599565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610d3a576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610d3190611519565b60405180910390fd5b80600260008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92583604051610e189190611619565b60405180910390a3505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415610e95576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610e8c90611579565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610f05576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610efc906114f9565b60405180910390fd5b610f108383836111fc565b6000600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015610f97576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610f8e90611539565b60405180910390fd5b8181610fa391906116c1565b600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555081600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254611035919061166b565b925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef846040516110999190611619565b60405180910390a350505050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415611117576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161110e906115f9565b60405180910390fd5b611123600083836111fc565b8060036000828254611135919061166b565b9250508190555080600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825461118b919061166b565b925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516111f09190611619565b60405180910390a35050565b505050565b60008135905061121081611a99565b92915050565b60008135905061122581611ab0565b92915050565b60006020828403121561123d57600080fd5b600061124b84828501611201565b91505092915050565b6000806040838503121561126757600080fd5b600061127585828601611201565b925050602061128685828601611201565b9150509250929050565b6000806000606084860312156112a557600080fd5b60006112b386828701611201565b93505060206112c486828701611201565b92505060406112d586828701611216565b9150509250925092565b600080604083850312156112f257600080fd5b600061130085828601611201565b925050602061131185828601611216565b9150509250929050565b61132481611707565b82525050565b60006113358261164f565b61133f818561165a565b935061134f81856020860161174a565b6113588161180d565b840191505092915050565b600061137060238361165a565b915061137b8261181e565b604082019050919050565b600061139360228361165a565b915061139e8261186d565b604082019050919050565b60006113b660268361165a565b91506113c1826118bc565b604082019050919050565b60006113d960288361165a565b91506113e48261190b565b604082019050919050565b60006113fc60258361165a565b91506114078261195a565b604082019050919050565b600061141f60248361165a565b915061142a826119a9565b604082019050919050565b6000611442601b8361165a565b915061144d826119f8565b602082019050919050565b600061146560258361165a565b915061147082611a21565b604082019050919050565b6000611488601f8361165a565b915061149382611a70565b602082019050919050565b6114a781611733565b82525050565b6114b68161173d565b82525050565b60006020820190506114d1600083018461131b565b92915050565b600060208201905081810360008301526114f1818461132a565b905092915050565b6000602082019050818103600083015261151281611363565b9050919050565b6000602082019050818103600083015261153281611386565b9050919050565b60006020820190508181036000830152611552816113a9565b9050919050565b60006020820190508181036000830152611572816113cc565b9050919050565b60006020820190508181036000830152611592816113ef565b9050919050565b600060208201905081810360008301526115b281611412565b9050919050565b600060208201905081810360008301526115d281611435565b9050919050565b600060208201905081810360008301526115f281611458565b9050919050565b600060208201905081810360008301526116128161147b565b9050919050565b600060208201905061162e600083018461149e565b92915050565b600060208201905061164960008301846114ad565b92915050565b600081519050919050565b600082825260208201905092915050565b600061167682611733565b915061168183611733565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156116b6576116b56117af565b5b828201905092915050565b60006116cc82611733565b91506116d783611733565b9250828210156116ea576116e96117af565b5b828203905092915050565b600061170082611713565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600060ff82169050919050565b60005b8381101561176857808201518184015260208101905061174d565b83811115611777576000848401525b50505050565b6000600282049050600182168061179557607f821691505b602082108114156117a9576117a86117de565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000601f19601f8301169050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206260008201527f616c616e63650000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206160008201527f6c6c6f77616e6365000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b7f61646472657373206d7573742062652077686974656c69737465640000000000600082015250565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760008201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b611aa2816116f5565b8114611aad57600080fd5b50565b611ab981611733565b8114611ac457600080fd5b5056fea26469706673582212205eb78eb066bc1b52ae2a609445354fdb37f425bc11dfb7dba0910a7b2564ba3a64736f6c63430008010033",
        abi: [{"inputs":[{"internalType":"string","name":"name_","type":"string"},{"internalType":"string","name":"symbol_","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"whitelist","outputs":[],"stateMutability":"nonpayable","type":"function"}]
    },
    "non-whitelist": {
        byteCode: "0x60806040523480156200001157600080fd5b506040516200194f3803806200194f833981810160405281019062000037919062000193565b81600390805190602001906200004f92919062000071565b5080600490805190602001906200006892919062000071565b50505062000376565b8280546200007f906200029b565b90600052602060002090601f016020900481019282620000a35760008555620000ef565b82601f10620000be57805160ff1916838001178555620000ef565b82800160010185558215620000ef579182015b82811115620000ee578251825591602001919060010190620000d1565b5b509050620000fe919062000102565b5090565b5b808211156200011d57600081600090555060010162000103565b5090565b60006200013862000132846200022f565b62000206565b9050828152602081018484840111156200015157600080fd5b6200015e84828562000265565b509392505050565b600082601f8301126200017857600080fd5b81516200018a84826020860162000121565b91505092915050565b60008060408385031215620001a757600080fd5b600083015167ffffffffffffffff811115620001c257600080fd5b620001d08582860162000166565b925050602083015167ffffffffffffffff811115620001ee57600080fd5b620001fc8582860162000166565b9150509250929050565b60006200021262000225565b9050620002208282620002d1565b919050565b6000604051905090565b600067ffffffffffffffff8211156200024d576200024c62000336565b5b620002588262000365565b9050602081019050919050565b60005b838110156200028557808201518184015260208101905062000268565b8381111562000295576000848401525b50505050565b60006002820490506001821680620002b457607f821691505b60208210811415620002cb57620002ca62000307565b5b50919050565b620002dc8262000365565b810181811067ffffffffffffffff82111715620002fe57620002fd62000336565b5b80604052505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b6000601f19601f8301169050919050565b6115c980620003866000396000f3fe608060405234801561001057600080fd5b50600436106100b45760003560e01c806340c10f191161007157806340c10f19146101a357806370a08231146101bf57806395d89b41146101ef578063a457c2d71461020d578063a9059cbb1461023d578063dd62ed3e1461026d576100b4565b806306fdde03146100b9578063095ea7b3146100d757806318160ddd1461010757806323b872dd14610125578063313ce567146101555780633950935114610173575b600080fd5b6100c161029d565b6040516100ce9190610fec565b60405180910390f35b6100f160048036038101906100ec9190610e17565b61032f565b6040516100fe9190610fd1565b60405180910390f35b61010f61034d565b60405161011c919061110e565b60405180910390f35b61013f600480360381019061013a9190610dc8565b610357565b60405161014c9190610fd1565b60405180910390f35b61015d610458565b60405161016a9190611129565b60405180910390f35b61018d60048036038101906101889190610e17565b610461565b60405161019a9190610fd1565b60405180910390f35b6101bd60048036038101906101b89190610e17565b61050d565b005b6101d960048036038101906101d49190610d63565b61051b565b6040516101e6919061110e565b60405180910390f35b6101f7610563565b6040516102049190610fec565b60405180910390f35b61022760048036038101906102229190610e17565b6105f5565b6040516102349190610fd1565b60405180910390f35b61025760048036038101906102529190610e17565b6106e9565b6040516102649190610fd1565b60405180910390f35b61028760048036038101906102829190610d8c565b610707565b604051610294919061110e565b60405180910390f35b6060600380546102ac90611272565b80601f01602080910402602001604051908101604052809291908181526020018280546102d890611272565b80156103255780601f106102fa57610100808354040283529160200191610325565b820191906000526020600020905b81548152906001019060200180831161030857829003601f168201915b5050505050905090565b600061034361033c61078e565b8484610796565b6001905092915050565b6000600254905090565b6000610364848484610961565b6000600160008673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006103af61078e565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000205490508281101561042f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104269061106e565b60405180910390fd5b61044c8561043b61078e565b858461044791906111b6565b610796565b60019150509392505050565b60006012905090565b600061050361046e61078e565b84846001600061047c61078e565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008873ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020546104fe9190611160565b610796565b6001905092915050565b6105178282610be0565b5050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b60606004805461057290611272565b80601f016020809104026020016040519081016040528092919081815260200182805461059e90611272565b80156105eb5780601f106105c0576101008083540402835291602001916105eb565b820191906000526020600020905b8154815290600101906020018083116105ce57829003601f168201915b5050505050905090565b6000806001600061060461078e565b73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050828110156106c1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106b8906110ce565b60405180910390fd5b6106de6106cc61078e565b8585846106d991906111b6565b610796565b600191505092915050565b60006106fd6106f661078e565b8484610961565b6001905092915050565b6000600160008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905092915050565b600033905090565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff161415610806576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107fd906110ae565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610876576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161086d9061102e565b60405180910390fd5b80600160008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020819055508173ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92583604051610954919061110e565b60405180910390a3505050565b600073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff1614156109d1576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016109c89061108e565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610a41576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610a389061100e565b60405180910390fd5b610a4c838383610d34565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054905081811015610ad2576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610ac99061104e565b60405180910390fd5b8181610ade91906111b6565b6000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002081905550816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610b6e9190611160565b925050819055508273ffffffffffffffffffffffffffffffffffffffff168473ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef84604051610bd2919061110e565b60405180910390a350505050565b600073ffffffffffffffffffffffffffffffffffffffff168273ffffffffffffffffffffffffffffffffffffffff161415610c50576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610c47906110ee565b60405180910390fd5b610c5c60008383610d34565b8060026000828254610c6e9190611160565b92505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254610cc39190611160565b925050819055508173ffffffffffffffffffffffffffffffffffffffff16600073ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef83604051610d28919061110e565b60405180910390a35050565b505050565b600081359050610d4881611565565b92915050565b600081359050610d5d8161157c565b92915050565b600060208284031215610d7557600080fd5b6000610d8384828501610d39565b91505092915050565b60008060408385031215610d9f57600080fd5b6000610dad85828601610d39565b9250506020610dbe85828601610d39565b9150509250929050565b600080600060608486031215610ddd57600080fd5b6000610deb86828701610d39565b9350506020610dfc86828701610d39565b9250506040610e0d86828701610d4e565b9150509250925092565b60008060408385031215610e2a57600080fd5b6000610e3885828601610d39565b9250506020610e4985828601610d4e565b9150509250929050565b610e5c816111fc565b82525050565b6000610e6d82611144565b610e77818561114f565b9350610e8781856020860161123f565b610e9081611302565b840191505092915050565b6000610ea860238361114f565b9150610eb382611313565b604082019050919050565b6000610ecb60228361114f565b9150610ed682611362565b604082019050919050565b6000610eee60268361114f565b9150610ef9826113b1565b604082019050919050565b6000610f1160288361114f565b9150610f1c82611400565b604082019050919050565b6000610f3460258361114f565b9150610f3f8261144f565b604082019050919050565b6000610f5760248361114f565b9150610f628261149e565b604082019050919050565b6000610f7a60258361114f565b9150610f85826114ed565b604082019050919050565b6000610f9d601f8361114f565b9150610fa88261153c565b602082019050919050565b610fbc81611228565b82525050565b610fcb81611232565b82525050565b6000602082019050610fe66000830184610e53565b92915050565b600060208201905081810360008301526110068184610e62565b905092915050565b6000602082019050818103600083015261102781610e9b565b9050919050565b6000602082019050818103600083015261104781610ebe565b9050919050565b6000602082019050818103600083015261106781610ee1565b9050919050565b6000602082019050818103600083015261108781610f04565b9050919050565b600060208201905081810360008301526110a781610f27565b9050919050565b600060208201905081810360008301526110c781610f4a565b9050919050565b600060208201905081810360008301526110e781610f6d565b9050919050565b6000602082019050818103600083015261110781610f90565b9050919050565b60006020820190506111236000830184610fb3565b92915050565b600060208201905061113e6000830184610fc2565b92915050565b600081519050919050565b600082825260208201905092915050565b600061116b82611228565b915061117683611228565b9250827fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff038211156111ab576111aa6112a4565b5b828201905092915050565b60006111c182611228565b91506111cc83611228565b9250828210156111df576111de6112a4565b5b828203905092915050565b60006111f582611208565b9050919050565b60008115159050919050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000819050919050565b600060ff82169050919050565b60005b8381101561125d578082015181840152602081019050611242565b8381111561126c576000848401525b50505050565b6000600282049050600182168061128a57607f821691505b6020821081141561129e5761129d6112d3565b5b50919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b6000601f19601f8301169050919050565b7f45524332303a207472616e7366657220746f20746865207a65726f206164647260008201527f6573730000000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a20617070726f766520746f20746865207a65726f20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206260008201527f616c616e63650000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207472616e7366657220616d6f756e742065786365656473206160008201527f6c6c6f77616e6365000000000000000000000000000000000000000000000000602082015250565b7f45524332303a207472616e736665722066726f6d20746865207a65726f20616460008201527f6472657373000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a20617070726f76652066726f6d20746865207a65726f2061646460008201527f7265737300000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a2064656372656173656420616c6c6f77616e63652062656c6f7760008201527f207a65726f000000000000000000000000000000000000000000000000000000602082015250565b7f45524332303a206d696e7420746f20746865207a65726f206164647265737300600082015250565b61156e816111ea565b811461157957600080fd5b50565b61158581611228565b811461159057600080fd5b5056fea2646970667358221220896a86a6aa9505fc75ed89561bc117f6aff501a930333fbf4560eef784b12fc264736f6c63430008010033",
        abi: [{"inputs":[{"internalType":"string","name":"name_","type":"string"},{"internalType":"string","name":"symbol_","type":"string"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"mint","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"sender","type":"address"},{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"}]
    }
}

let erc20Contract;

web3.utils.hexToNumber = utils.hexToNumber;
web3.eth.transactionBlockTimeout = 100000;

const methods = [
    {
        name: 'traceTransaction',
        call: 'debug_traceTransaction',
        params: 2
    },
];

web3.extend({
    property: 'debug',
    methods
});

const allOpcodes = [
    'PUSH1',        'MSTORE',   'CALLVALUE',
    'DUP1',         'ISZERO',   'PUSH2',
    'JUMPI',        'JUMPDEST', 'POP',
    'CALLDATASIZE', 'LT',       'CALLDATALOAD',
    'SHR',          'PUSH4',    'GT',
    'EQ',           'SUB',      'DUP2',
    'ADD',          'SWAP1',    'SWAP2',
    'JUMP',         'DUP4',     'DUP6',
    'SLT',          'DUP3',     'DUP7',
    'PUSH20',       'AND',      'SWAP3',
    'CALLER',       'DUP5',     'SHA3',
    'SLOAD',        'SSTORE',   'PUSH32',
    'MLOAD',        'LOG3',     'RETURN',
    'DUP8',         'SWAP4',    'EXP',
    'DIV',          'DUP10',    'DUP9',
    'SWAP5'
];

let output = [];

async function deploy(abi, bytecode) {
    return new web3.eth.Contract(abi)
        .deploy({data: bytecode, arguments: ["PTR", "PTR"]})
        .send({from: addressNode1, gas: 15000000})
        .then(function(newContractInstance){
            erc20Contract = newContractInstance;
            return newContractInstance;
        });
}

async function transfer(sender, receiver, amount) {
    return erc20Contract.methods
        .transfer(receiver, amount)
        .send({from: sender, gas: 14000000})
        .then(function(receipt){
            return receipt;
        });
}

async function approve(sender, receiver, amount) {
    return erc20Contract.methods
        .approve(receiver, amount)
        .send({from: sender, gas: 14000000})
        .then(function(receipt){
            return receipt;
        });
}

async function transferFrom(owner, sender, receiver, amount) {
    return erc20Contract.methods
        .transferFrom(owner, receiver, amount)
        .send({from: sender, gas: 14000000})
        .then(function(receipt){
            return receipt;
        });
}

async function mint(minter, amount) {
    return erc20Contract.methods
        .mint(minter, amount)
        .send({from: minter, gas: 14000000});
}

async function whitelist(account) {
    return erc20Contract.methods
        .whitelist(account)
        .send({from: account, gas: 14000000});
}

async function traceTx(txHash) {
    return web3.debug.traceTransaction(txHash, {});
}

function sortTrace(traceObj) {
    let ops = traceObj.structLogs;
    let results = {};

    let totalGasUsedAll = 0;

    for(let i=0; i<allOpcodes.length; i++) {
        results[allOpcodes[i]] = {
            totalGas: 0,
            found: 0
        };
    }

    for(let i=0; i<ops.length; i++) {
        let currentOp = ops[i];
        let opcode = currentOp.op;

        results[opcode].totalGas += currentOp.gasCost;
        totalGasUsedAll += currentOp.gasCost;
        results[opcode].found++;
    }

    for(let i=0; i<allOpcodes.length; i++) {
        // let asPercent = results[allOpcodes[i]].totalGas / totalGasUsedAll;
        // if (results[allOpcodes[i]].found !== 0) {
        //     asPercent /= results[allOpcodes[i]].found;
        // }
        // results[allOpcodes[i]].totalGas = 100 * (Math.round((asPercent + Number.EPSILON) * 1000) / 1000);
        // results[allOpcodes[i]].totalGas = (100 * asPercent).toFixed(3);
        // results[allOpcodes[i]].totalGas = results[allOpcodes[i]].totalGas.toFixed(3);

        results[allOpcodes[i]].totalGas = results[allOpcodes[i]].found;
    }

    return results;
}

async function runCall(title, inputFunc) {
    let receipt = await inputFunc();
    let res = await traceTx(receipt.transactionHash)

    let completeResult = {};
    completeResult.title = title;
    completeResult.trace = await traceTx(receipt.transactionHash);
    completeResult.opcodeResult = sortTrace(res);


    let q = [];
    for(let i=0; i<allOpcodes.length; i++) {
        q.push(completeResult.opcodeResult[allOpcodes[i]].totalGas);
    }

    output.push(q);

    return completeResult;
}

async function runSingleCase(testCase, doWhitelist) {

    output = [];
    output.push(allOpcodes);

    await deploy(testCase.abi, testCase.byteCode);
    if(doWhitelist) {
        await whitelist(addressNode1);
        await whitelist(addressNode2);
        await whitelist(addressNode3);
    }
    await mint(addressNode1, 1000000);

    await runCall("Transfer 1", async function() {return transfer(addressNode1, addressNode2, 100)});
    await runCall("Transfer 2", async function() {return transfer(addressNode1, addressNode2, 100)});
    await runCall("Transfer 3", async function() {return transfer(addressNode2, addressNode1, 200)});

    await runCall("Approve 1", async function() {return approve(addressNode1, addressNode2, 100)});
    await runCall("Approve 2", async function() {return approve(addressNode1, addressNode2, 200)});
    await runCall("Approve 3", async function() {return approve(addressNode1, addressNode2, 200)});
    await runCall("Approve 4", async function() {return approve(addressNode1, addressNode2, 0)});

    await approve(addressNode1, addressNode2, 1000);
    await runCall("TransferFrom 1", async function() {return transferFrom(addressNode1, addressNode2, addressNode3, 500)});
    await runCall("TransferFrom 2", async function() {return transferFrom(addressNode1, addressNode2, addressNode3, 500)});


    let txsed = transposeArray(output, allOpcodes.length);
    for(let i=0; i<txsed.length; i++){
        console.log(txsed[i].join(","));
    }

    return "";
}

async function run() {
    //non-whitelist contract
    await runSingleCase(testCases["non-whitelist"], false)
    console.log();
    console.log();
    console.log();
    await runSingleCase(testCases.whitelist, true)

    return null;
}

(async () => {
    await run();
    process.exit(0);
})();

function transposeArray(a) {
    return a[0].map(function (_, c) { return a.map(function (r) { return r[c]; }); });
    // or in more modern dialect
    // return a[0].map((_, c) => a.map(r => r[c]));
}